<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OmniVPN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --secondary-text: rgba(255,255,255,0.5);
            --border-color: rgba(255,255,255,0.1);
            --button-bg: rgba(255,255,255,0.02);
            --button-border: rgba(255,255,255,0.2);
            --button-hover-bg: rgba(255,255,255,0.06);
            --accent-bg: rgba(255,255,255,0.03);
            --primary-bg: rgba(255,255,255,0.9);
            --primary-text: #000000;
            --status-bg: rgba(255,255,255,0.03);
            --wave-border: rgba(255,255,255,0.1);
            --wave-glow: rgba(255,255,255,0.03);
            --overlay-bg: rgba(0,0,0,0.7);
            --card-bg: rgba(255,255,255,0.05);
            --card-active-bg: rgba(255,255,255,0.15);
            --disabled-bg: rgba(255,255,255,0.1);
            --disabled-text: rgba(255,255,255,0.3);
            --expired-color: #ff5f5f; /* –ù–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ */
        }

        .theme-light {
            --bg-color: #ffffff;
            --text-color: #000000;
            --secondary-text: rgba(0,0,0,0.5);
            --border-color: rgba(0,0,0,0.1);
            --button-bg: rgba(0,0,0,0.02);
            --button-border: rgba(0,0,0,0.2);
            --button-hover-bg: rgba(0,0,0,0.05);
            --accent-bg: rgba(0,0,0,0.03);
            --primary-bg: rgba(0,0,0,0.9);
            --primary-text: #ffffff;
            --status-bg: rgba(0,0,0,0.02);
            --wave-border: rgba(0,0,0,0.1);
            --wave-glow: rgba(0,0,0,0.03);
            --overlay-bg: rgba(255,255,255,0.7);
            --card-bg: rgba(0,0,0,0.03);
            --card-active-bg: rgba(0,0,0,0.1);
            --disabled-bg: rgba(0,0,0,0.05);
            --disabled-text: rgba(0,0,0,0.2);
            --expired-color: #d32f2f; /* –¢–µ–º–Ω–µ–µ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
        }

        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
        /* (–∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞) */
        /* –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ —è –ø—Ä–æ–ø—É—Å–∫–∞—é –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é —Å—Ç–∏–ª–µ–π, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã */
        /* –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å –¥–ª—è –∏—Å—Ç–µ–∫—à–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ */
        .status-expired {
            color: var(--expired-color) !important;
        }
    </style>
</head>
<body>
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã (—Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º) -->
    <div class="theme-switcher" id="themeSwitcher">
        <div class="theme-button" id="themeToggle">‚ö™</div>
    </div>

    <div class="app">
        <div class="content-wrapper">
            <div class="logo-section">
                <div class="logo-wrapper">
                    <img src="https://raw.githubusercontent.com/marktvencc-hue/omnivpn-webapp/main/photo_5226932146939826416_c.png" alt="OmniVPN" class="logo-image" id="logoImg">
                    <div class="wave-container">
                        <div class="wave wave-1"></div>
                        <div class="wave wave-2"></div>
                        <div class="wave wave-3"></div>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
                <div id="mainScreen">
                    <div class="actions-container">
                        <div id="statusText" class="status-text">
                            <div class="loading-container">
                                <span class="loader"></span>
                                <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                        </div>
                        
                        <button class="button" onclick="showTariffs()">üí∞ –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
                        <button class="button" onclick="showSetup()">üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</button>
                        
                        <div class="profile-row">
                            <button class="button" onclick="showProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                            <button class="faq-button" onclick="openFAQ()">‚ùì FAQ</button>
                        </div>
                    </div>
                </div>

                <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞ (–æ—Ñ–æ—Ä–º–ª–µ–Ω –∫–∞–∫ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é) -->
                <div id="tariffsScreen" class="hidden">
                    <div class="actions-container">
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</h3>
                        <div class="tariff-grid" id="tariffGrid">
                            <div class="tariff-card" data-tariff="1month">
                                <div class="tariff-name">1 –º–µ—Å—è—Ü</div>
                                <div class="tariff-price">264.99 ‚ÇΩ</div>
                            </div>
                            <div class="tariff-card" data-tariff="3months">
                                <div class="tariff-name">3 –º–µ—Å—è—Ü–∞</div>
                                <div class="tariff-price">429 ‚ÇΩ</div>
                            </div>
                            <div class="tariff-card" data-tariff="6months">
                                <div class="tariff-name">6 –º–µ—Å—è—Ü–µ–≤</div>
                                <div class="tariff-price">599 ‚ÇΩ</div>
                            </div>
                            <div class="tariff-card" data-tariff="1year">
                                <div class="tariff-name">1 –≥–æ–¥</div>
                                <div class="tariff-price">849 ‚ÇΩ</div>
                            </div>
                        </div>
                    </div>
                    <div class="pay-button-container">
                        <button class="button-primary" id="payButton" disabled onclick="handlePayClick()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
                    </div>
                    <button class="button secondary back-button" onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
                </div>

                <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –Ω–µ –¥—É–±–ª–∏—Ä—É—é –≤—Å—ë) -->
                <!-- ... (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞) ... -->
            </div>
        </div>
    </div>

    <!-- Bottom Sheet (–≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –º–µ–Ω—é) -->
    <div class="overlay" id="overlay" onclick="closePaymentSheet()"></div>
    <div class="bottom-sheet" id="paymentSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
        <div class="payment-option" onclick="payWithSBP()">
            <span class="payment-option-icon"><img src="https://cdn.freekassa.net/images/currencies/light_small_logo_44.png" alt="–°–ë–ü"></span>
            <span class="payment-option-text">–û–ø–ª–∞—Ç–∞ –ø–æ –°–ë–ü</span>
        </div>
        <div class="payment-option" onclick="payWithSberPay()">
            <span class="payment-option-icon"><img src="https://cdn.freekassa.net/images/currencies/light_small_logo_43.png" alt="Sber Pay"></span>
            <span class="payment-option-text">Sber Pay</span>
        </div>
        <div class="payment-option" onclick="payWithStars()">
            <span class="payment-option-icon">‚≠ê</span>
            <span class="payment-option-text">Telegram Stars</span>
        </div>
        <div class="payment-option" onclick="payWithCard()">
            <span class="payment-option-icon"><img src="https://cdn.freekassa.net/images/currencies/light_small_logo_36.png" alt="–ö–∞—Ä—Ç–∞"></span>
            <span class="payment-option-text">–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π</span>
        </div>
        <div class="close-sheet" onclick="closePaymentSheet()">–ó–∞–∫—Ä—ã—Ç—å</div>
    </div>

    <script>
        const API_URL = 'https://omnivpn.us.ci';
        const SUPPORT_BOT_USERNAME = 'omnivpnhelpbot';
        const SUPPORT_EMAIL = 'support@omnivpn.us.ci';

        const TARIFF_PRICES_RUB = {
            '1month': 264.99,
            '3months': 429,
            '6months': 599,
            '1year': 849
        };
        const PAYMENT_METHODS = {
            card: 36,
            sbp: 44,
            sberpay: 43
        };

        let selectedTariff = null;
        let currentSubscriptionUrl = '';
        let currentStep = 1;

        // Telegram WebApp
        if (!window.Telegram || !window.Telegram.WebApp) {
            document.body.innerHTML = '<div style="padding:20px;text-align:center;color:white;background:black;">‚ùå –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram</div>';
            throw new Error('Not in Telegram');
        }
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.setHeaderColor('#000000');
        tg.setBackgroundColor('#000000');

        // –¢–µ–º–∞
        const logoImg = document.getElementById('logoImg');
        const LOGO_WHITE = 'https://raw.githubusercontent.com/marktvencc-hue/omnivpn-webapp/main/photo_5226932146939826416_c.png';
        const LOGO_BLACK = 'https://raw.githubusercontent.com/marktvencc-hue/omnivpn-webapp/main/photo_5226932146939826416_cBLACK.png';
        const themeToggle = document.getElementById('themeToggle');
        const themeSwitcher = document.getElementById('themeSwitcher');
        const body = document.body;

        function setTheme(theme) {
            body.classList.remove('theme-light', 'theme-dark');
            if (theme === 'light') {
                body.classList.add('theme-light');
                logoImg.src = LOGO_BLACK;
                themeToggle.textContent = 'üåë';
            } else {
                body.classList.add('theme-dark');
                logoImg.src = LOGO_WHITE;
                themeToggle.textContent = '‚ö™';
            }
            localStorage.setItem('selectedTheme', theme);
        }
        let savedTheme = localStorage.getItem('selectedTheme');
        if (savedTheme !== 'light' && savedTheme !== 'dark') savedTheme = 'dark';
        setTheme(savedTheme);
        themeToggle.addEventListener('click', () => {
            setTheme(body.classList.contains('theme-dark') ? 'light' : 'dark');
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function showScreen(screenId) {
            document.querySelectorAll('#mainScreen, #tariffsScreen, #setupScreen, #profileScreen, #referralScreen, #transactionsScreen, #agreementScreen, #faqScreen, #aboutScreen, #privacyScreen, #contactScreen').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            themeSwitcher.classList.toggle('hidden', screenId !== 'mainScreen');
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        function backToMain() {
            showScreen('mainScreen');
            loadStatus(); // –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        }

        function backToProfile() { showScreen('profileScreen'); }
        function backToAbout() { showScreen('aboutScreen'); }

        function showTariffs() { 
            showScreen('tariffsScreen'); 
            clearSelectedTariff();
        }
        function showProfile() { showScreen('profileScreen'); }
        function showSetup() { showScreen('setupScreen'); document.getElementById('deviceHint').innerText = `–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ ${tg.platform || 'unknown'}`; }
        function showReferral() { showScreen('referralScreen'); loadReferralInfo(); }
        function showTransactions() { showScreen('transactionsScreen'); loadTransactions(); }
        function showAbout() { showScreen('aboutScreen'); }
        function showPrivacy() { showScreen('privacyScreen'); }
        function showContact() { showScreen('contactScreen'); }
        function openAgreement() { showScreen('agreementScreen'); }
        function openFAQ() { showScreen('faqScreen'); }
        function openSupport() { tg.openTelegramLink('https://t.me/' + SUPPORT_BOT_USERNAME); }

        // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
        const tariffCards = document.querySelectorAll('.tariff-card');
        const payButton = document.getElementById('payButton');

        function clearSelectedTariff() {
            tariffCards.forEach(card => card.classList.remove('active'));
            selectedTariff = null;
            payButton.disabled = true;
        }

        tariffCards.forEach(card => {
            card.addEventListener('click', () => {
                tariffCards.forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                selectedTariff = card.dataset.tariff;
                payButton.disabled = false;
            });
        });

        function handlePayClick() {
            if (!selectedTariff) {
                alert('–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ');
                return;
            }
            openPaymentSheet();
        }

        // Bottom Sheet
        const overlay = document.getElementById('overlay');
        const paymentSheet = document.getElementById('paymentSheet');

        function openPaymentSheet() {
            overlay.classList.add('active');
            paymentSheet.classList.add('active');
        }

        function closePaymentSheet() {
            overlay.classList.remove('active');
            paymentSheet.classList.remove('active');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–≤–∞–π–ø–æ–º –≤–Ω–∏–∑
        let startY = 0;
        paymentSheet.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
        }, { passive: true });
        paymentSheet.addEventListener('touchmove', (e) => {
            if (startY - e.touches[0].clientY < -50) {
                closePaymentSheet();
            }
        }, { passive: true });

        // –§—É–Ω–∫—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã
        async function payWithCard() {
            closePaymentSheet();
            if (selectedTariff) await buyTariffFreekassa(selectedTariff, PAYMENT_METHODS.card);
        }
        async function payWithSBP() {
            closePaymentSheet();
            if (selectedTariff) await buyTariffFreekassa(selectedTariff, PAYMENT_METHODS.sbp);
        }
        async function payWithSberPay() {
            closePaymentSheet();
            if (selectedTariff) await buyTariffFreekassa(selectedTariff, PAYMENT_METHODS.sberpay);
        }
        async function payWithStars() {
            closePaymentSheet();
            if (selectedTariff) await buyTariffStars(selectedTariff);
        }

        async function buyTariffStars(tariff) {
            try {
                const data = await fetchWithAuth(API_URL + '/api/create_invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tariff })
                });
                if (data.invoice_link) {
                    tg.openInvoice(data.invoice_link, async function(status) {
                        if (status === 'paid') {
                            await loadStatus();
                            backToMain();
                        }
                    });
                } else alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á—ë—Ç–∞');
            } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
        }

        async function buyTariffFreekassa(tariff, method) {
            try {
                const data = await fetchWithAuth(API_URL + '/api/create_freekassa_invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tariff, payment_method: method })
                });
                if (data.payment_url) {
                    tg.openLink(data.payment_url);
                } else alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á—ë—Ç–∞');
            } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏—Å—Ç–µ—á–µ–Ω–∏—è
        async function loadStatus() {
            try {
                const data = await fetchWithAuth(API_URL + '/api/user_status');
                const statusEl = document.getElementById('statusText');
                let expiryText = '', statusText = '', statusClass = '';

                if (data.is_unlimited) {
                    expiryText = '–±–µ—Å—Å—Ä–æ—á–Ω—ã–π –¥–æ—Å—Ç—É–ø';
                    statusText = 'PREMIUM';
                } else if (data.subscription_end) {
                    const endDate = new Date(data.subscription_end);
                    const now = new Date();
                    const isActive = endDate > now; // –ø—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∫—Ä–∞—Å–∏–≤–æ
                    const formattedDate = endDate.toLocaleDateString('ru-RU', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric' 
                    }).replace(' –≥.', '');

                    if (isActive) {
                        statusText = '–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞';
                        expiryText = `–¥–æ ${formattedDate}`;
                    } else {
                        statusText = '–ò—Å—Ç–µ–∫–ª–∞';
                        expiryText = `–∏—Å—Ç–µ–∫–ª–∞ ${formattedDate}`;
                        statusClass = 'status-expired'; // –∫–ª–∞—Å—Å –¥–ª—è –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
                    }
                } else {
                    expiryText = '‚Äî';
                    statusText = '–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏';
                }

                statusEl.innerHTML = `
                    <div class="status-ultima">
                        <div class="status-left"><span class="status-service-name">OMNI</span></div>
                        <div class="status-right">
                            <span class="status-expiry">${expiryText}</span>
                            <span class="status-badge-large ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                `;
                currentSubscriptionUrl = data.subscription_url || '';
            } catch {
                document.getElementById('statusText').innerHTML = '<div class="status-ultima">...</div>';
            }
        }

        // –î–û–ë–ê–í–õ–ï–ù–û: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && document.getElementById('mainScreen') && !document.getElementById('mainScreen').classList.contains('hidden')) {
                loadStatus();
            }
        });

        async function copySubscriptionLink() {
            if (!currentSubscriptionUrl) { alert('–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
            try { await navigator.clipboard.writeText(currentSubscriptionUrl); alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); }
            catch { alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
        }

        function copyEmail() {
            navigator.clipboard.writeText(SUPPORT_EMAIL).then(() => alert('‚úÖ Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + SUPPORT_EMAIL)).catch(() => alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å email'));
        }

        async function loadReferralInfo() {
            try {
                const data = await fetchWithAuth(API_URL + '/api/referral_info');
                let html = `<div class="info-row"><span class="info-label">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π:</span> <span class="info-value">${data.count}</span></div>`;
                html += `<div class="info-row"><span class="info-label">–í–∞—à–∞ —Å—Å—ã–ª–∫–∞:</span> <span class="link">${data.link}</span></div>`;
                html += `<h4 style="margin:24px 0 16px;">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</h4>`;
                if (data.history.length === 0) html += '<p style="color:var(--secondary-text);">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</p>';
                else data.history.forEach(item => {
                    const date = new Date(item.created_at).toLocaleDateString();
                    html += `<div class="info-row"><span class="info-label">${date}</span> <span class="info-value">+${item.bonus_days} –¥–Ω–µ–π</span></div>`;
                });
                document.getElementById('referralInfo').innerHTML = html;
            } catch { document.getElementById('referralInfo').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; }
        }

        async function loadTransactions() {
            try {
                const trans = await fetchWithAuth(API_URL + '/api/transactions');
                let html = '';
                if (trans.length === 0) html = '<p style="color:var(--secondary-text);">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫</p>';
                else trans.forEach(t => {
                    const date = new Date(t.created_at).toLocaleDateString();
                    html += `<div class="info-row"><span class="info-label">${date} (${t.tariff})</span> <span class="info-value">${t.amount_stars} ‚≠ê</span></div>`;
                });
                document.getElementById('transactionsList').innerHTML = html;
            } catch { document.getElementById('transactionsList').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞
        function startSetup() {
            document.getElementById('startSetupContainer').style.display = 'none';
            document.getElementById('setupSteps').classList.remove('hidden');
            document.getElementById('step1').classList.remove('hidden');
            updateStepIndicators(1);
        }
        function installApp() {
            const APP_LINKS = {
                android: 'https://app.hiddify.com/play',
                ios: 'https://apps.apple.com/ru/app/v2box-v2ray-client/id6446814690',
                ipados: 'https://apps.apple.com/ru/app/v2box-v2ray-client/id6446814690',
                windows: 'https://app.hiddify.com/windows',
                macos: 'https://app.hiddify.com/mac',
                linux: 'https://app.hiddify.com/linux'
            };
            tg.openLink(APP_LINKS[tg.platform] || APP_LINKS.android);
            nextStep();
        }
        async function addSubscription() {
            if (!currentSubscriptionUrl) { alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞'); return; }
            const btn = document.querySelector('#step2 .button-primary');
            btn.innerText = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'; btn.disabled = true;
            try {
                const encodedUrl = encodeURIComponent(currentSubscriptionUrl);
                let deepLink = (tg.platform === 'ios' || tg.platform === 'ipados') ? `v2box://install-sub?url=${encodedUrl}` : `hiddify://import/${encodedUrl}`;
                const link = document.createElement('a'); link.href = deepLink; link.target = '_blank'; link.style.display = 'none';
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                setTimeout(() => { btn.innerText = '‚ûï –î–æ–±–∞–≤–∏—Ç—å'; btn.disabled = false; nextStep(); }, 2000);
            } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); btn.innerText = '‚ûï –î–æ–±–∞–≤–∏—Ç—å'; btn.disabled = false; }
        }
        function nextStep() {
            if (currentStep === 1) { document.getElementById('step1').classList.add('hidden'); document.getElementById('step2').classList.remove('hidden'); currentStep = 2; updateStepIndicators(2); }
            else if (currentStep === 2) { document.getElementById('step2').classList.add('hidden'); document.getElementById('step3').classList.remove('hidden'); currentStep = 3; updateStepIndicators(3); }
        }
        function finishSetup() { backToMain(); }
        function updateStepIndicators(step) {
            document.querySelectorAll('.step').forEach((el, i) => { if (i+1 === step) el.classList.add('active'); else el.classList.remove('active'); });
        }

        async function fetchWithAuth(url, options = {}) {
            options.headers = { ...options.headers, 'X-Telegram-Init-Data': tg.initData || '' };
            const response = await fetch(url, options);
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error || `HTTP ${response.status}`);
            }
            return response.json();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showScreen('mainScreen');
        loadStatus();
        clearSelectedTariff();
    </script>
</body>
</html>
